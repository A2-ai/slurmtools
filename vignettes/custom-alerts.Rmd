---
title: "custom-alerts"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{custom-alerts}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(slurmtools)
```

Submitting a NONMEM job with nmm

Instead of using bbi we can use nmm (NONMEM Monitor) which currently has some additional functionality of sending slack notifications as well as gradient monitoring.

We can update the template file accordingly:

#!/bin/bash
#SBATCH --job-name="{{job_name}}"
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task={{ncpu}}
#SBATCH --partition={{partition}}

{{nmm_exe_path}} -c {{config_toml_path}} run

default, submit_nonmem_model will provide nmm_exe_path and config_toml_path to the template. Behind the scenes nmm_exe_path is determined with Sys.which("nmm") which may or may not give you the path to the nmm binary if it is on your path or not. We can inject the nmm_exe_path like we did with bbi_exe_path and assume it's not on our path.

Remember that error about the config.toml file not existing? Well this is the reason. This file controls what nmm will monitor and where to look for files and how to alert you. We'll use generate_nmm_config() to create this file. First we can look at the documentation to see what type of information we should pass to this function.

{r}
slurmtools::generate_nmm_config(mod)

This generates the following toml file. Notice that alert is set to 'None', and email is empty. Since we're in vignettes we'll need to update the watched_dir and output_dir.

Additionally, If we want to take advatnage of nmm's slack notifications we'll have to add a few arguments to the generate_nmm_config function.

model_number = '1001'
files_to_track = [ 'lst', 'ext', 'grd' ]
tmp_dir = '/tmp'
watched_dir = '/cluster-data/user-homes/matthews/Packages/slurmtools/model/nonmem'
output_dir = '/cluster-data/user-homes/matthews/Packages/slurmtools/model/nonmem/in_progress'
poll_duration = 1
alert = 'None'
level = 'Debug'
email = ''
threads = 1

{r}
slurmtools::generate_nmm_config(
  mod, 
  alert = "slack", 
  email = "matthews@a2-ai.com",
  watched_dir = "/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem",
  output_dir = "/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem/in_progress")

model_number = '1001'
files_to_track = [ 'lst', 'ext', 'grd' ]
tmp_dir = '/tmp'
watched_dir = '/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem'
output_dir = '/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem/in_progress'
poll_duration = 1
alert = 'Slack'
level = 'Debug'
email = 'matthews@a2-ai.com'
threads = 1

We can now run submit_nonmem_model and get slack notifications about our run.

{r}
submission_nmm <- slurmtools::submit_nonmem_model(
  mod, 
  overwrite = TRUE,
  slurm_job_template_path = file.path(nonmem, "slurm-job-nmm.tmpl"),
  slurm_template_opts = list(nmm_exe_path = normalizePath("~/.local/bin/nmm"))
)

submission_nmm

With alert = 'Slack' and email set in the config.toml file nmm should send slack notifications directly to you when a NONMEM run starts and it will reply to that message with notifications if any gradients hit 0 and when the run finishes it checks if all -1E9 lines are present in the .ext file and gives another message about any parameters that hit 0 gradient. 
