<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Slack-alerts • slurmtools</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Slack-alerts">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">slurmtools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-get-started" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Get Started</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-get-started">
<li><a class="dropdown-item" href="../articles/Running-nonmem.html">Running NONMEM</a></li>
    <li><a class="dropdown-item" href="../articles/custom-alerts.html">Custom Alerts</a></li>
    <li><a class="dropdown-item" href="../articles/slack-alerts.html">Slack Alerts</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/a2-ai/slurmtools"><span class="fa fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Slack-alerts</h1>
            
      

      <div class="d-none name"><code>slack-alerts.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(slurmtools)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>──  [<span class="dv">1</span>mNeeded slurmtools options [<span class="dv">22</span>m ───────────────────────────────────────────────────</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a> [<span class="dv">31</span>m✖ [<span class="dv">39</span>m <span class="fu">option</span>(<span class="st">'slurmtools.slurm_job_template_path'</span>) is not set.</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a> [<span class="dv">31</span>m✖ [<span class="dv">39</span>m <span class="fu">option</span>(<span class="st">'slurmtools.submission_root'</span>) is not set.</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a> [<span class="dv">31</span>m✖ [<span class="dv">39</span>m <span class="fu">option</span>(<span class="st">'slurmtools.bbi_config_path'</span>) is not set.</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a> [<span class="dv">36</span>mℹ [<span class="dv">39</span>m Please set all options <span class="cf">for</span> job submission defaults to work.</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="fu">library</span>(bbr)</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="fu">here</span>() starts at <span class="sc">/</span>home<span class="sc">/</span>runner<span class="sc">/</span>work<span class="sc">/</span>slurmtools<span class="sc">/</span>slurmtools</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>nonmem <span class="ot">=</span> <span class="fu">file.path</span>(here<span class="sc">::</span><span class="fu">here</span>(), <span class="st">"vignettes"</span>, <span class="st">"model"</span>, <span class="st">"nonmem"</span>)</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="fu">options</span>(<span class="st">'slurmtools.submission_root'</span> <span class="ot">=</span> <span class="fu">file.path</span>(nonmem, <span class="st">"submission-log"</span>))</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_number</span> <span class="op">&lt;-</span> <span class="st">"1001"</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">nonmem</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">mod_number</span>, <span class="st">".yaml"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">bbr</span><span class="fu">::</span><span class="fu"><a href="https://metrumresearchgroup.github.io/bbr/reference/read_model.html" class="external-link">read_model</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">nonmem</span>, <span class="va">mod_number</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">bbr</span><span class="fu">::</span><span class="fu"><a href="https://metrumresearchgroup.github.io/bbr/reference/new_model.html" class="external-link">new_model</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">nonmem</span>, <span class="va">mod_number</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level2">
<h2 id="cut-me-some-slack">Cut me some Slack<a class="anchor" aria-label="anchor" href="#cut-me-some-slack"></a>
</h2>
<p>There is also functionality to pair <a href="https://github.com/A2-ai/nonmem-monitor/releases" class="external-link"><code>nmm</code></a>
with <a href="https://github.com/A2-ai/slack_notifier/releases/" class="external-link">slack_notifier</a>
and get messages sent directly to you via a slack bot. This requires you
to download the slack_notifier binaries. You can download the latest
release and extract the binary and again save it to
<code>~/.local/bin</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.which.html" class="external-link">Sys.which</a></span><span class="op">(</span><span class="st">"snt"</span><span class="op">)</span></span>
<span>                                               <span class="va">snt</span> </span>
<span><span class="st">"/cluster-data/user-homes/matthews/.local/bin/snt"</span></span></code></pre></div>
<p><code>snt</code> requires the slack bot OAuth token which is found
from <code>https://api.slack.com/apps/&lt;YOUR_APP_ID&gt;/oauth?</code>.
This can be saved in a file and fed into the <code>snt</code> with the
<code>tokenFile</code> flag.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode slack_notifier/config.yaml"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">token</span><span class="kw">:</span><span class="at"> </span><span class="st">"encrypted(Bot User OAuth Token)"</span></span></code></pre></div>
<p>Again, we need to update the <code>1001.toml</code> file to get slack
notifications. If we look at the <code>snt</code> help message we see
that it should be called via
<code>snt slack -c config_file -k decryption_key -a token -f tokenFile -e email -m message -t timestamp</code></p>
<p>the config_file can contain the key, and token file so you don’t need
to repeatedly use that information. I’ve saved the tokenFile location
and key in a config file in
<code>~/.local/bin/slack_notifier_settings.yaml</code> and will use the
-c flag to point to that.</p>
<p>With this our call to <code>snt</code> would look like:</p>
<p><code>snt slack -c ~/.local/bin/slack_notifier_settings.yaml -e matthews@a2-ai.com -m "Hello"</code></p>
<p>The timestamp flag is needed if we want to reply to a message, which
to save on spamming alerts we want to do. However, since we can’t
possible know the timestamp of a message we have yet to send we don’t
have a way of specifying this argument now. This is what the use_stdout
argument for <code>nmm</code> alerter is for. It will capture the
standard out of the call to the alerter binary and parse it for
additional flags to use on subsequent calls. With all this in mind, we
can update our <code>nmm</code> config to achieve this slack
messaging.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">slurmtools</span><span class="fu">::</span><span class="fu"><a href="../reference/generate_nmm_config.html">generate_nmm_config</a></span><span class="op">(</span> </span>
<span>  <span class="va">mod</span>, </span>
<span>  watched_dir <span class="op">=</span> <span class="st">"/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem"</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem/in_progress"</span>,</span>
<span>  alerter_opts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    alerter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.which.html" class="external-link">Sys.which</a></span><span class="op">(</span><span class="st">'snt'</span><span class="op">)</span>, <span class="co">#binary location of nmm,</span></span>
<span>    command <span class="op">=</span> <span class="st">"slack"</span>,</span>
<span>    message_flag <span class="op">=</span> <span class="st">"m"</span>, <span class="co">#This is the default so we don't need to specify it</span></span>
<span>    use_stdout <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co">#captures output of snt -- which will include --timestamp aksfl;ajklajl;</span></span>
<span>    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>email <span class="op">=</span> <span class="st">"matthews@a2-ai.com"</span>, config <span class="op">=</span> <span class="st">"/cluster-data/user-homes/matthews/.local/bin/slack_notifier_settings.yaml"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>This generates the following toml file:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode 1001.toml"><code class="sourceCode toml"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="dt">model_number</span> <span class="op">=</span> <span class="st">'</span><span class="vs">1001</span><span class="st">'</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="dt">watched_dir</span> <span class="op">=</span> <span class="st">'</span><span class="vs">/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem</span><span class="st">'</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="dt">output_dir</span> <span class="op">=</span> <span class="st">'</span><span class="vs">/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem/in_progress</span><span class="st">'</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="kw">[alerter]</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="dt">alerter</span> <span class="op">=</span> <span class="st">'</span><span class="vs">/cluster-data/user-homes/matthews/.local/bin/snt</span><span class="st">'</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="dt">command</span> <span class="op">=</span> <span class="st">'</span><span class="vs">slack</span><span class="st">'</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="dt">message_flag</span> <span class="op">=</span> <span class="st">'</span><span class="vs">m</span><span class="st">'</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="dt">use_stdout</span> <span class="op">=</span> <span class="cn">true</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="kw">[alerter.args]</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a><span class="dt">email</span> <span class="op">=</span> <span class="st">'</span><span class="vs">matthews@a2-ai.com</span><span class="st">'</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="dt">config</span> <span class="op">=</span> <span class="st">'</span><span class="vs">/cluster-data/user-homes/matthews/.local/bin/slack_notifier_settings.yaml</span><span class="st">'</span></span></code></pre></div>
<p>With <code>alert = 'Slack'</code> and <code>email</code> set in the
<code>1001.toml</code> file <code>nmm</code> will send slack
notifications directly to you when a NONMEM run starts and it will reply
to that message with notifications if any gradients hit 0 and when the
run finishes it checks if all -1E9 lines are present in the .ext file
and gives another message about any parameters that hit 0 gradient.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>submission_nmm <span class="ot">&lt;-</span> slurmtools<span class="sc">::</span><span class="fu">submit_nonmem_model</span>( </span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  mod, </span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>  <span class="at">slurm_job_template_path =</span> <span class="fu">file.path</span>(nonmem, <span class="st">"slurm-job-nmm.tmpl"</span>),</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  <span class="at">slurm_template_opts =</span> <span class="fu">list</span>(</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>    <span class="at">nmm_exe_path =</span> <span class="fu">normalizePath</span>(<span class="st">"~/.local/bin/nmm"</span>)</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>  )</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>)</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>Warning <span class="cf">in</span> <span class="fu">normalizePath</span>(<span class="st">"~/.local/bin/nmm"</span>)<span class="sc">:</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>path[<span class="dv">1</span>]<span class="ot">=</span><span class="st">"/home/runner/.local/bin/nmm"</span><span class="sc">:</span> No such file or directory</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>submission_nmm</span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a><span class="sc">$</span>status</span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">0</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a><span class="sc">$</span>stdout</span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"Submitted batch job 804</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a><span class="sc">$</span>stderr</span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">""</span></span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a><span class="sc">$</span>timeout</span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a>[<span class="dv">1</span>] <span class="cn">FALSE</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>slurmtools<span class="sc">::</span><span class="fu">get_slurm_jobs</span>()</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a> [<span class="dv">38</span>;<span class="dv">5</span>;<span class="dv">246</span>m<span class="co"># A tibble: 1 × 12 [39m</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>  job_id partition  user_name job_state time     cpus standard_input</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>    [<span class="dv">3</span>m [<span class="dv">38</span>;<span class="dv">5</span>;<span class="dv">246</span>m<span class="sc">&lt;</span>int<span class="sc">&gt;</span> [<span class="dv">39</span>m [<span class="dv">23</span>m  [<span class="dv">3</span>m [<span class="dv">38</span>;<span class="dv">5</span>;<span class="dv">246</span>m<span class="sc">&lt;</span>chr<span class="sc">&gt;</span> [<span class="dv">39</span>m [<span class="dv">23</span>m       [<span class="dv">3</span>m [<span class="dv">38</span>;<span class="dv">5</span>;<span class="dv">246</span>m<span class="sc">&lt;</span>chr<span class="sc">&gt;</span> [<span class="dv">39</span>m [<span class="dv">23</span>m      [<span class="dv">3</span>m [<span class="dv">38</span>;<span class="dv">5</span>;<span class="dv">246</span>m<span class="sc">&lt;</span>chr<span class="sc">&gt;</span> [<span class="dv">39</span>m [<span class="dv">23</span>m      [<span class="dv">3</span>m [<span class="dv">38</span>;<span class="dv">5</span>;<span class="dv">246</span>m<span class="sc">&lt;</span>drtn<span class="sc">&gt;</span> [<span class="dv">39</span>m [<span class="dv">23</span>m   [<span class="dv">3</span>m [<span class="dv">38</span>;<span class="dv">5</span>;<span class="dv">246</span>m<span class="sc">&lt;</span>int<span class="sc">&gt;</span> [<span class="dv">39</span>m [<span class="dv">23</span>m  [<span class="dv">3</span>m [<span class="dv">38</span>;<span class="dv">5</span>;<span class="dv">246</span>m<span class="sc">&lt;</span>chr<span class="sc">&gt;</span> [<span class="dv">39</span>m [<span class="dv">23</span>m         </span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a> [<span class="dv">38</span>;<span class="dv">5</span>;<span class="dv">250</span>m1 [<span class="dv">39</span>m    [<span class="dv">4</span>m1 [<span class="dv">24</span>m159 cpu2mem4gb matthews  COMPLETED <span class="dv">13</span> secs     <span class="dv">1</span> <span class="sc">/</span>dev<span class="sc">/</span>null     </span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a> [<span class="dv">38</span>;<span class="dv">5</span>;<span class="dv">246</span>m<span class="co"># ℹ 5 more variables: standard_output &lt;chr&gt;, submit_time &lt;dttm&gt;, [39m</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a> [<span class="dv">38</span>;<span class="dv">5</span>;<span class="dv">246</span>m<span class="co">#   start_time &lt;dttm&gt;, end_time &lt;dttm&gt;, current_working_directory &lt;chr&gt; [39m</span></span></code></pre></div>
<div class="float">
<img src="data%2Fimages%2Fnmm_slack_notifications.png" alt="nmm slack alerts"><div class="figcaption">nmm slack alerts</div>
</div>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Devin Pastoor, Jenna Elwing, Matthew Smith.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
