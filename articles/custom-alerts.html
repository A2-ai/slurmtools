<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Setting up custom alerts • slurmtools</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Setting up custom alerts">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">slurmtools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-get-started" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Get Started</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-get-started">
<li><a class="dropdown-item" href="../articles/Running-nonmem.html">Running NONMEM</a></li>
    <li><a class="dropdown-item" href="../articles/custom-alerts.html">Custom Alerts</a></li>
    <li><a class="dropdown-item" href="../articles/slack-alerts.html">Slack Alerts</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/a2-ai/slurmtools"><span class="fa fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Setting up custom alerts</h1>
            
      

      <div class="d-none name"><code>custom-alerts.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">slurmtools</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in get(paste0(generic, ".", class), envir = get_method_env()) : </span></span>
<span><span class="co">#&gt;   object 'type_sum.accel' not found</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Needed slurmtools options</span> ───────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> options('slurmtools.slurm_job_template_path') is not set.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> options('slurmtools.submission_root') is not set.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> options('slurmtools.bbi_config_path') is not set.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please set all options for job submission defaults to work.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metrumresearchgroup.github.io/bbr" class="external-link">bbr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/" class="external-link">here</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; here() starts at /home/runner/work/slurmtools/slurmtools</span></span>
<span></span>
<span><span class="va">nonmem</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"vignettes"</span>, <span class="st">"model"</span>, <span class="st">"nonmem"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="st">'slurmtools.submission_root'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">nonmem</span>, <span class="st">"submission-log"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="submitting-a-nonmem-job-with-nmm">Submitting a NONMEM job with nmm<a class="anchor" aria-label="anchor" href="#submitting-a-nonmem-job-with-nmm"></a>
</h2>
<p>Instead of using bbi we can use <code>nmm</code> (<a href="https://github.com/A2-ai/nonmem-monitor/releases" class="external-link">NONMEM
Monitor</a>) which currently has some additional functionality of
sending notifications about zero gradients, missing -1E9 lines in ext
file, and some very basic control stream errors. Nonmem-monitor also
allows for setting up an alerter to be better fed these messages - more
on that later. To use <code>nmm</code> you can install the latest
release from the github repository linked above.</p>
<p>We can update the template file accordingly:</p>
<pre class="slurm-job-nmm.tmpl"><code>#!/bin/bash 
#SBATCH --job-name="{{job_name}}" 
#SBATCH --nodes=1 
#SBATCH --ntasks=1
#SBATCH --cpus-per-task={{ncpu}} 
#SBATCH --partition={{partition}}

{{nmm_exe_path}} -c {{config_toml_path}} run</code></pre>
<p>default, <code>submit_slurm_job</code> will provide
<code>nmm_exe_path</code> and <code>config_toml_path</code> to the
template. Just like with <code>bbi_exe_path</code>,
<code>nmm_exe_path</code> is determined with
<code>Sys.which("nmm")</code> which may or may not give you the path to
the nmm binary if it is on your path or not. We can inject the
<code>nmm_exe_path</code> like we did with <code>bbi_exe_path</code> and
assume it’s not on our path.</p>
<p>The <code>config.toml</code> file controls what <code>nmm</code> will
monitor and where to look for files and how to alert you. We’ll use
<code><a href="../reference/generate_nmm_config.html">generate_nmm_config()</a></code> to create this file. First we can
look at the documentation to see what type of information we should pass
to this function. <code>?generate_nmm_config()</code></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_number</span> <span class="op">&lt;-</span> <span class="st">"1001"</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">nonmem</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">mod_number</span>, <span class="st">".yaml"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">bbr</span><span class="fu">::</span><span class="fu"><a href="https://metrumresearchgroup.github.io/bbr/reference/read_model.html" class="external-link">read_model</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">nonmem</span>, <span class="va">mod_number</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">bbr</span><span class="fu">::</span><span class="fu"><a href="https://metrumresearchgroup.github.io/bbr/reference/new_model.html" class="external-link">new_model</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">nonmem</span>, <span class="va">mod_number</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">slurmtools</span><span class="fu">::</span><span class="fu"><a href="../reference/generate_nmm_config.html">generate_nmm_config</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in slurmtools::generate_nmm_config(mod): bbi.yaml path not supplied</span></span>
<span><span class="co">#&gt; through options('slurmtools.bbi_config_path') or through arguments</span></span></code></pre></div>
<p>This generates the following toml file. By passing in just the mod
object, <code>nmm</code> will use the default values for the other
options so if you need to change which files are tracked, or how many
threads to use you’ll have to explicitly pass that to
<code>generate_nmm_config</code>. Since we’re in vignettes we’ll need to
update the <code>watched_dir</code> and <code>output_dir</code>
accordingly.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode 1001.toml"><code class="sourceCode toml"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="dt">model_number</span> <span class="op">=</span> <span class="st">'</span><span class="vs">1001</span><span class="st">'</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="dt">watched_dir</span> <span class="op">=</span> <span class="st">'</span><span class="vs">/cluster-data/user-homes/matthews/Packages/slurmtools/model/nonmem</span><span class="st">'</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="dt">output_dir</span> <span class="op">=</span> <span class="st">'</span><span class="vs">/cluster-data/user-homes/matthews/Packages/slurmtools/model/nonmem/in_progress</span><span class="st">'</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">slurmtools</span><span class="fu">::</span><span class="fu"><a href="../reference/generate_nmm_config.html">generate_nmm_config</a></span><span class="op">(</span> </span>
<span>  <span class="va">mod</span>, </span>
<span>  watched_dir <span class="op">=</span> <span class="st">"/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem"</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem/in_progress"</span>,</span>
<span>  bbi_config_path <span class="op">=</span> <span class="st">"/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem/bbi.yaml"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>This updates the <code>1001.toml</code> config file to:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode 1001.toml"><code class="sourceCode toml"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="dt">model_number</span> <span class="op">=</span> <span class="st">'</span><span class="vs">1001</span><span class="st">'</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="dt">watched_dir</span> <span class="op">=</span> <span class="st">'</span><span class="vs">/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem</span><span class="st">'</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="dt">output_dir</span> <span class="op">=</span> <span class="st">'</span><span class="vs">/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem/in_progress</span><span class="st">'</span></span></code></pre></div>
<p>We can now run <code>submit_slurm_job</code> and get essentially the
same behavior as running with <code>bbi</code>. On linux
<code>~/.local/bin/</code> will be on your path so saving the downloaded
binaries there is a good approach.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">submission_nmm</span> <span class="op">&lt;-</span> <span class="fu">slurmtools</span><span class="fu">::</span><span class="fu"><a href="../reference/submit_slurm_job.html">submit_slurm_job</a></span><span class="op">(</span> </span>
<span>  <span class="va">mod</span>, </span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  slurm_job_template_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">nonmem</span>, <span class="st">"slurm-job-nmm.tmpl"</span><span class="op">)</span>,</span>
<span>  slurm_template_opts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    nmm_exe_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/normalizePath.html" class="external-link">normalizePath</a></span><span class="op">(</span><span class="st">"~/.local/bin/nmm"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in normalizePath("~/.local/bin/nmm"):</span></span>
<span><span class="co">#&gt; path[1]="/home/runner/.local/bin/nmm": No such file or directory</span></span>
<span></span>
<span><span class="va">submission_nmm</span></span>
<span><span class="co">#&gt; $status</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $stdout</span></span>
<span><span class="co">#&gt; [1] "Submitted batch job 804\n"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $stderr</span></span>
<span><span class="co">#&gt; [1] ""</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $timeout</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">slurmtools</span><span class="fu">::</span><span class="fu"><a href="../reference/get_slurm_jobs.html">get_slurm_jobs</a></span><span class="op">(</span>user <span class="op">=</span> <span class="st">"matthews"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 13</span></span></span>
<span><span class="co">#&gt;   job_id partition  job_name     user_name job_state time    cpus standard_input</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;time&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>   <span style="text-decoration: underline;">1</span>159 cpu2mem4gb 1001-nonmem… matthews  COMPLETED 00<span style="color: #949494;">'</span>13<span style="color: #949494;">"</span>     1 /dev/null     </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 5 more variables: standard_output &lt;chr&gt;, submit_time &lt;dttm&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   start_time &lt;dttm&gt;, end_time &lt;dttm&gt;, current_working_directory &lt;chr&gt;</span></span></span></code></pre></div>
<p>The one difference between using <code>nmm</code> compared to
<code>bbi</code> is that a new directory is created that contains a log
file that caught some issues with our run. This file is updated as
nonmem is running and monitors gradient values, parameters that hit
zero, as well as other errors from bbi. Looking at the first few lines
we can see that <code>bbi</code> was successfully able to call nonmem.
We also see an info level log that OMEGA(2,1) has 0 value – in our mod
file we don’t specify any omega values off the diagonal so these are
fixed at 0. Finally we see that GRD(6) hit 0 relatively early in the
run.</p>
<pre class="vignettes/model/nonmem/in_progress/1001/modeling_run_20240827201226.log"><code>19:13:45 [INFO] bbi log: time="2024-09-20T19:13:45Z" level=info msg="Successfully loaded default configuration from /cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem/bbi.yaml"
19:13:45 [INFO] bbi log: time="2024-09-20T19:13:45Z" level=info msg="Beginning Local Path"
19:13:45 [INFO] bbi log: time="2024-09-20T19:13:45Z" level=info msg="A total of 1 models have completed the initial preparation phase"
19:13:45 [INFO] bbi log: time="2024-09-20T19:13:45Z" level=info msg="[1001] Beginning local work phase"
19:14:16 [INFO] "/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem/1001/1001.ext": Iteration: 5, Parameter(s) that hit zero: ["SIGMA(2,1)", "OMEGA(2,1)"]
19:14:19 [INFO] "/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem/1001/1001.ext": Iteration: 10, Parameter(s) that hit zero: ["OMEGA(2,1)", "SIGMA(2,1)"]
19:14:21 [INFO] "/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem/1001/1001.ext": Iteration: 15, Parameter(s) that hit zero: ["SIGMA(2,1)", "OMEGA(2,1)"]
19:14:21 [WARN] "/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem/1001/1001.grd" Iteration: 10, has 0 gradient for parameter(s): ["GRD(6)"] </code></pre>
<p>After a run has finished several messages are sent to the log after a
final check of the files listed in the <code>files_to_track</code> field
of the <code>1001.toml</code> file.</p>
<pre class="vignettes/model/nonmem/in_progress/1001/modeling_run_20240827201226.log"><code>19:14:31 [INFO] Received Exit code: exit status: 0
19:14:31 [WARN] 1001.ext: Missing ext final output lines. Observed lines were: [-1000000000.0, -1000000004.0, -1000000006.0, -1000000007.0]
19:14:31 [WARN] "/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem/1001/1001.grd": The following parameters hit zero gradient through the run: ["GRD(6)"]</code></pre>
<p>We see that GRD(6) hit zero during the run and that only a subset of
the -1E9 lines were present in the .ext file.</p>
</div>
<div class="section level2">
<h2 id="getting-alerted-during-a-run">Getting alerted during a run<a class="anchor" aria-label="anchor" href="#getting-alerted-during-a-run"></a>
</h2>
<p>Like we did with <code>bbi</code> and altering the slurm template
file to get notifications from <a href="ntfy.sh">ntfy.sh</a>
<code>nmm</code> has this feature built in! The messages in the log file
that relate to zero gradients, missing -1E9 lines, and 0 parameter
values can also be sent to ntfy by altering the <code>1001.toml</code>
file. We can get these alerts in real time without having to dig through
a noisy log file.</p>
<p>Let’s update our call to <code>generate_nmm_config</code> to have
<code>nmm</code> send notifications to the <code>NONMEMmonitor</code>
topic on <a href="ntfy.sh">ntfy.sh</a>. Just like how
<code>submit_slurm_job</code> can feed additional information to the
template with <code>slurm_template_opts</code>, we can add an alerter
feature to nmm with <code>alerter_opts</code>. If we go to ntfy.sh we
can see that to send a message to ntfy we can run
<code>curl -d "Backup successful 😀"  ntfy.sh/mytopic</code>.
<code>nmm</code> can call a binary with a command and pass a message to
a flag. For ntfy, the binary is <code>curl</code> the message flag is
<code>d</code> and the command is <code>ntfy.sh/mytopic</code> and there
are no additional args.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">slurmtools</span><span class="fu">::</span><span class="fu"><a href="../reference/generate_nmm_config.html">generate_nmm_config</a></span><span class="op">(</span> </span>
<span>  <span class="va">mod</span>, </span>
<span>  watched_dir <span class="op">=</span> <span class="st">"/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem"</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem/in_progress"</span>,</span>
<span>  alerter_opts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    alerter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.which.html" class="external-link">Sys.which</a></span><span class="op">(</span><span class="st">'curl'</span><span class="op">)</span>, <span class="co">#binary location of curl,</span></span>
<span>    command <span class="op">=</span> <span class="st">"ntfy.sh/NONMEMmonitor"</span>,</span>
<span>    message_flag <span class="op">=</span> <span class="st">"d"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in slurmtools::generate_nmm_config(mod, watched_dir =</span></span>
<span><span class="co">#&gt; "/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem",</span></span>
<span><span class="co">#&gt; : bbi.yaml path not supplied through options('slurmtools.bbi_config_path') or</span></span>
<span><span class="co">#&gt; through arguments</span></span></code></pre></div>
<p>This updates the <code>1001.toml</code> file to this:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode 1001.toml"><code class="sourceCode toml"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="dt">model_number</span> <span class="op">=</span> <span class="st">'</span><span class="vs">1001</span><span class="st">'</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="dt">watched_dir</span> <span class="op">=</span> <span class="st">'</span><span class="vs">/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem</span><span class="st">'</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="dt">output_dir</span> <span class="op">=</span> <span class="st">'</span><span class="vs">/cluster-data/user-homes/matthews/Packages/slurmtools/vignettes/model/nonmem/in_progress</span><span class="st">'</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="kw">[alerter]</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="dt">alerter</span> <span class="op">=</span> <span class="st">'</span><span class="vs">/usr/bin/curl</span><span class="st">'</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="dt">command</span> <span class="op">=</span> <span class="st">'</span><span class="vs">ntfy.sh/NONMEMmonitor</span><span class="st">'</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a><span class="dt">message_flag</span> <span class="op">=</span> <span class="st">'</span><span class="vs">d</span><span class="st">'</span></span></code></pre></div>
<p>When we re-run the <code>submit_slurm_job</code> call we will now get
ntfy notifications. One thing to note is that <code>nmm</code> will
print full paths in the log, but will only send notifications with the
<code>model_number</code> (or
<code>model_number.file_extension</code>).</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">submission_nmm</span> <span class="op">&lt;-</span> <span class="fu">slurmtools</span><span class="fu">::</span><span class="fu"><a href="../reference/submit_slurm_job.html">submit_slurm_job</a></span><span class="op">(</span> </span>
<span>  <span class="va">mod</span>, </span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  slurm_job_template_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">nonmem</span>, <span class="st">"slurm-job-nmm.tmpl"</span><span class="op">)</span>,</span>
<span>  slurm_template_opts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    nmm_exe_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/normalizePath.html" class="external-link">normalizePath</a></span><span class="op">(</span><span class="st">"~/.local/bin/nmm"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in normalizePath("~/.local/bin/nmm"):</span></span>
<span><span class="co">#&gt; path[1]="/home/runner/.local/bin/nmm": No such file or directory</span></span>
<span></span>
<span><span class="va">submission_nmm</span></span>
<span><span class="co">#&gt; $status</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $stdout</span></span>
<span><span class="co">#&gt; [1] "Submitted batch job 804\n"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $stderr</span></span>
<span><span class="co">#&gt; [1] ""</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $timeout</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">slurmtools</span><span class="fu">::</span><span class="fu"><a href="../reference/get_slurm_jobs.html">get_slurm_jobs</a></span><span class="op">(</span>user <span class="op">=</span> <span class="st">"matthews"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 13</span></span></span>
<span><span class="co">#&gt;   job_id partition  job_name     user_name job_state time    cpus standard_input</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;time&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>   <span style="text-decoration: underline;">1</span>159 cpu2mem4gb 1001-nonmem… matthews  COMPLETED 00<span style="color: #949494;">'</span>13<span style="color: #949494;">"</span>     1 /dev/null     </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 5 more variables: standard_output &lt;chr&gt;, submit_time &lt;dttm&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   start_time &lt;dttm&gt;, end_time &lt;dttm&gt;, current_working_directory &lt;chr&gt;</span></span></span></code></pre></div>
<p>This gives us the notifications in a much more digestible format</p>
<div class="float">
<img src="data%2Fimages%2Fnmm_ntfy_alerts.png" alt="nmm ntfy.sh alerts"><div class="figcaption">nmm ntfy.sh alerts</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Devin Pastoor, Jenna Elwing, Matthew Smith.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
